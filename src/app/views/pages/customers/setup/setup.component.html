<app-breadcrumb></app-breadcrumb>

<div class="row">
  <div class="col-md-12 stretch-card">
    <div class="card">
      <div class="card-body">
        <form class="forms-sample" (submit)="onSubmit($event)">
          <input type="hidden" name="id" [(ngModel)]="currentRecord.id">

          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label">ID / Code <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="code"
                    [(ngModel)]="currentRecord.code" (ngModelChange)="clearError('code')">
              <div class="text-danger mt-1" *ngIf="formErrors.code">{{ formErrors.code[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Customer Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="name"
                    [(ngModel)]="currentRecord.name" (ngModelChange)="clearError('name')">
              <div class="text-danger mt-1" *ngIf="formErrors.name">{{ formErrors.name[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">CNIC <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="cnic"
                    [(ngModel)]="currentRecord.cnic" (ngModelChange)="clearError('cnic')">
              <div class="text-danger mt-1" *ngIf="formErrors.cnic">{{ formErrors.cnic[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-control" name="email_address"
                    [(ngModel)]="currentRecord.email_address" (ngModelChange)="clearError('email_address')">
              <div class="text-danger mt-1" *ngIf="formErrors.email_address">{{ formErrors.email_address[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Phone Number</label>
              <input type="text" class="form-control" name="phone_number"
                    [(ngModel)]="currentRecord.phone_number" (ngModelChange)="clearError('phone_number')">
              <div class="text-danger mt-1" *ngIf="formErrors.phone_number">{{ formErrors.phone_number[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Mobile Number</label>
              <input type="text" class="form-control" name="mobile_number"
                    [(ngModel)]="currentRecord.mobile_number" (ngModelChange)="clearError('mobile_number')">
              <div class="text-danger mt-1" *ngIf="formErrors.mobile_number">{{ formErrors.mobile_number[0] }}</div>
            </div>
            
            <div class="col-md-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label">Select City <span class="text-danger">*</span></label>
                <a href="javascript:;" class="text-primary small" (click)="openCityModal()">Add New City</a>
              </div>
              <ng-select
                [items]="cities"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="currentRecord.city_id"
                name="city_id"
                placeholder="Select one"
                [searchable]="true"
                (change)="clearError('city_id')">
              </ng-select>
              <div class="text-danger mt-1" *ngIf="formErrors.city_id">{{ formErrors.city_id[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Credit Balance</label>
              <input type="number" class="form-control" name="credit_balance"
                    [(ngModel)]="currentRecord.credit_balance" (ngModelChange)="clearError('credit_balance')">
              <div class="text-danger mt-1" *ngIf="formErrors.credit_balance">{{ formErrors.credit_balance[0] }}</div>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Credit Limit</label>
              <input type="number" class="form-control" name="credit_limit"
                    [(ngModel)]="currentRecord.credit_limit" (ngModelChange)="clearError('credit_limit')">
              <div class="text-danger mt-1" *ngIf="formErrors.credit_limit">{{ formErrors.credit_limit[0] }}</div>
            </div>
            
            <div class="col-md-3 mb-3">
              <label class="form-label">Status <span class="text-danger">*</span></label>
              <ng-select
                [items]="status"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="currentRecord.status"
                name="status"
                placeholder="Select one"
                [searchable]="false"
                (change)="clearError('status')">
              </ng-select>
              <div class="text-danger mt-1" *ngIf="formErrors.status">{{ formErrors.status[0] }}</div>
            </div>

            <div class="col-md-12 mb-3">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" rows="3"
                        [(ngModel)]="currentRecord.address" (ngModelChange)="clearError('address')"></textarea>
              <div class="text-danger mt-1" *ngIf="formErrors.address">{{ formErrors.address[0] }}</div>
            </div>

            <!-- Image Upload -->
            <div class="col-md-12 mb-3">
              <label class="form-label">Upload Image</label>
              <input type="file" name="customer_image" class="form-control" (change)="onFileSelected($event)">
              <div class="text-danger mt-1" *ngIf="formErrors.image">{{ formErrors.image[0] }}</div>

              <!-- Image Preview -->
              <div class="mt-3 image-preview" *ngIf="imagePreview">
                <div class="image-wrapper">
                  <img [src]="imagePreview" alt="Customer Image" class="img-thumbnail" style="max-width: 150px;">
                  <span class="close-icon" (click)="removeImage()"></span>
                </div>
              </div>
            </div>

            <div class="col-12 mt-3">
              <button type="submit" [disabled]="isLoading" class="btn btn-primary">Save Changes</button>
            </div>

            <div class="col-12 mt-3" *ngIf="globalErrorMessage">
              <div class="alert alert-danger text-center">
                {{ globalErrorMessage }}
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<ng-template #modalTemplate let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Add New City</h5>
    <button type="button" class="btn-close" (click)="modal.close()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form (submit)="citySubmit($event)">
      <div class="mb-3">
        <label class="form-label">Name <span class="text-danger">*</span></label>
        <input type="text" class="form-control" name="name"
          [(ngModel)]="cityRecord.name" (input)="clearError('name')">
        <div class="text-danger mt-1" *ngIf="formErrorsCity.name">{{ formErrorsCity.name[0] }}</div>
      </div>

      <div class="text-end">
        <button type="submit" [disabled]="isLoading" class="btn btn-primary">
          <span *ngIf="!isLoading">Save</span>
          <span *ngIf="isLoading"><i class="fa fa-spinner fa-spin"></i> Saving...</span>
        </button>
      </div>
    </form>
  </div>
</ng-template>
